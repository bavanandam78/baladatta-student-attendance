<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance PWA</title>

  <!-- Material Design Lite -->
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

  <!-- Google Identity & API -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>

  <style>
    body { font-family: 'Roboto', sans-serif; background: #f5f5f5; }
    .page-content { padding: 20px; max-width: 800px; margin: auto; }
    .student-card { margin: 10px 0; padding: 15px; background: white; border-radius: 8px; }
    .mdl-radio { margin-right: 10px; }
    .submit-btn { margin-top: 20px; width: 100%; }
    .student-name { font-weight: bold; margin-bottom: 10px; display: block; }
  </style>
</head>
<body>
  <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
    <header class="mdl-layout__header">
      <div class="mdl-layout__header-row">
        <span class="mdl-layout-title">Attendance System</span>
      </div>
    </header>
    <main class="mdl-layout__content">
      <div class="page-content">
        <button id="loginBtn" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
          Sign in with Google
        </button>

        <div id="attendanceSection" style="display:none;">
          <h4>Mark Attendance (0â€“5)</h4>
          <div id="studentList"></div>
          <button id="submitBtn" class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent submit-btn">
            Submit Attendance
          </button>
        </div>
      </div>
    </main>
  </div>

  <script>
    const CLIENT_ID = "616775302508-biqim0dii3rcja4uvicei4du27vfnvkc.apps.googleusercontent.com";
    const SPREADSHEET_ID = "1gYLl6Avt4bd8tb3S8BBjHKa-P6NU9fxNFt3ZzNz2wuk";
    const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

    let tokenClient;
    let attendance = {};
    let teacherName = "";

    // Load Google API client
    gapi.load("client", async () => {
      await gapi.client.init({
        discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
      });
    });

    window.onload = () => {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: async (resp) => {
          if (resp.error !== undefined) {
            console.error(resp);
            return;
          }

          teacherName = "Teacher"; // TODO: decode real teacher name from ID token

          document.getElementById("attendanceSection").style.display = "block";
          document.getElementById("loginBtn").style.display = "none";

          await loadStudents();
        },
      });

      document.getElementById("loginBtn").onclick = () => {
        tokenClient.requestAccessToken({ prompt: "consent" });
      };

      document.getElementById("submitBtn").onclick = submitAttendance;
    };

    async function loadStudents() {
      try {
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: "Students!A2:A", // Students list
        });

        const students = response.result.values ? response.result.values.flat() : [];
        renderStudents(students);
      } catch (err) {
        console.error("Error loading students:", err);
      }
    }

    function renderStudents(students) {
      const listDiv = document.getElementById("studentList");
      listDiv.innerHTML = "";
      students.forEach((student) => {
        attendance[student] = 0; // default level = 0
        const div = document.createElement("div");
        div.className = "student-card mdl-shadow--2dp";

        let radios = "";
        for (let i = 0; i <= 5; i++) {
          radios += `
            <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="level-${i}-${student}">
              <input type="radio" id="level-${i}-${student}" class="mdl-radio__button"
                name="${student}" value="${i}" ${i===0 ? "checked" : ""}
                onchange="mark('${student}', ${i})" />
              <span class="mdl-radio__label">${i}</span>
            </label>
          `;
        }

        div.innerHTML = `
          <span class="student-name">${student}</span>
          <div>${radios}</div>
        `;
        listDiv.appendChild(div);
        componentHandler.upgradeElements(div); // Re-init MDL
      });
    }

    function mark(student, level) {
      attendance[student] = level;
    }

    async function submitAttendance() {
      const today = new Date().toISOString().split("T")[0];
      const rows = Object.entries(attendance).map(([student, level]) => [
        today, teacherName, student, level,
      ]);

      try {
        await gapi.client.sheets.spreadsheets.values.append({
          spreadsheetId: SPREADSHEET_ID,
          range: "Attendance!A1",
          valueInputOption: "RAW",
          resource: { values: rows },
        });
        alert("Attendance submitted!");
      } catch (err) {
        console.error(err);
        alert("Error submitting attendance.");
      }
    }
  </script>
</body>
</html>
